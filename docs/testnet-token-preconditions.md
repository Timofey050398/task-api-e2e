# Подготовка предусловий для тестов создания токенов на тестнетах

Документ описывает, как подготовить окружение для прогона сценариев, которые создают криптовалютные кошельки и инициируют тестовые переводы токенов через `AccountService`. Сюда входят настройки пользователей, сетей и ключей, необходимых для работы сервисов блокчейнов.

## 1. Базовые требования

1. Установите Node.js версии 18+ и npm.
2. Установите зависимости проекта:
   ```bash
   npm ci
   ```
3. Создайте файл `.env` в корне репозитория и задайте в нём все перечисленные ниже переменные окружения. Переменные загружаются из `.env` автоматически за счёт использования `dotenv` в фикстурах и сервисах.

## 2. Учётные данные тестовых пользователей

Сценарии авторизации и работы API используют объект `USER_ONE`, поэтому требуется полный набор параметров пользователя и Telegram-бота для получения 2FA-кода.

| Переменная | Назначение |
| --- | --- |
| `TEST_USER_LOGIN` | Логин пользователя из тестового окружения.
| `TEST_USER_PASS` | Пароль пользователя.
| `TEST_PIN` | ПИН-код для завершения авторизации.
| `MAILTM_EMAIL` | Почтовый ящик, куда приходит письмо для восстановления.
| `TG_API_ID` / `TG_API_HASH` | Данные Telegram-приложения.
| `TG_SESSION` | Сессионная строка для быстрого входа без OTP.
| `TG_PHONE_NUMBER` | Используемый номер (нужен для логов).

> При необходимости добавьте второй набор переменных (`*_OTHER`) для параллельных запусков.

## 3. Доступ к API платформы

HTTP-клиенты поднимаются с базовым URL `https://srv.aifory.pro/lk/v1` и могут использовать токен авторизации, если он задан в `API_TOKEN`. Убедитесь, что у тестового пользователя есть права на создание кошельков и депозиты.

## 4. Настройка сетей блокчейнов

`BlockchainServiceFacade` проксирует запросы в специализированные сервисы для BTC, ETH, Tron и TON. Для корректной работы установите переменные и убедитесь, что выбран тестнет, а на ключах есть достаточно монет для комиссий и минимальных сумм депозитов (`getMinAmount`).

### 4.1 Bitcoin Testnet

BTC-транзакции создаются через `BtcTransactionService`, которому нужны адрес и приватный ключ в формате WIF.

Обязательные переменные:

- `BTC_NETWORK=testnet`
- `BTC_ADDRESS` — адрес отправителя в тестовой сети.
- `BTC_PRIVATE_KEY` — приватный ключ того же адреса (WIF).

Рекомендуемые параметры (опционально):

- `BTC_BLOCKSTREAM_API_BASE_URL` — альтернативный REST API для отправки/проверки транзакций.
- `BTC_MEMPOOL_API_BASE_URL` — API для расчёта комиссий.

**Как получить адрес и монеты:**

1. Сгенерируйте пару ключей с помощью [bitcoinlib](https://pypi.org/project/bitcoinlib/) или готового генератора вроде [https://www.bitaddress.org](https://www.bitaddress.org) (переключите сеть на Testnet и сохраните приватный ключ в формате WIF).
2. Проверьте адрес через Blockstream explorer `https://blockstream.info/testnet/address/<адрес>` и убедитесь, что он пустой.
3. Получите тестовые BTC через один из faucet:
   - `https://bitcoinfaucet.uo1.net/`
   - `https://testnet-faucet.mempool.co/`
4. Дождитесь, пока транзакция получит 1–2 подтверждения; после этого баланс можно использовать в тестах.

### 4.2 Ethereum (ERC-20) Testnet

Для ETH и токенов ERC-20 используется `EthTransactionService`, который требует RPC-узел и приватный ключ кошелька.

Обязательные переменные:

- `ETH_NETWORK=sepolia` (или другой поддерживаемый тестнет: `holesky`, `goerli`).
- `ETH_RPC_URL` — URL RPC-узла (если не хотите использовать дефолт из `config`).
- `ETH_PRIVATE_KEY` — приватный ключ кошелька в шестнадцатеричном виде без префикса `0x`.

Для токенов:

- `USDT_ERC20_CONTRACT`, `USDC_ERC20_CONTRACT` — адреса контрактов на выбранном тестнете.

**Как получить адрес и токены:**

1. Сгенерируйте кошелёк с помощью `ethers`:
   ```bash
   node -e "const { Wallet } = require('ethers'); const w = Wallet.createRandom(); console.log(w.address, w.privateKey);"
   ```
   Сохраните адрес и приватный ключ (удалите префикс `0x` перед сохранением в `.env`).
2. Добавьте сеть Sepolia/Holesky в Metamask и импортируйте адрес (или используйте CLI-инструменты `cast wallet import`).
3. Получите тестовые ETH через faucet:
   - `https://sepoliafaucet.com/` (через GitHub OAuth)
   - `https://holesky-faucet.pk910.de/`
4. Для USDT/USDC воспользуйтесь децентрализованными обменниками в тестовой сети (например, Uniswap Sepolia) или запросите токены на страницах проекта. Проверьте баланс через `https://sepolia.etherscan.io/address/<адрес>`.

### 4.3 Tron Testnet

`TronTransactionService` требует приватный ключ аккаунта Tron и адреса нод сети. При отсутствии пользовательских URL используются Shasta/Nile.

Обязательные переменные:

- `TRON_NETWORK=shasta` (или `nile`).
- `TRON_PRIVATE_KEY` — приватный ключ отправителя.

Опциональные переменные для своих узлов:

- `TRON_FULL_NODE`
- `TRON_SOLIDITY_NODE`
- `TRON_EVENT_SERVER`

Для TRC-20:

- `USDT_TRC20_CONTRACT` — адрес контракта на выбранном тестнете.

**Как получить адрес и токены:**

1. Откройте [https://nile.tronscan.org/#/wallet/new](https://nile.tronscan.org/#/wallet/new) или используйте `tron-cli` (`npm install -g tron-cli && tron-cli create`). Сохраните адрес, приватный ключ и mnemonic.
2. Активируйте тестовую сеть Shasta или Nile в TronLink и импортируйте созданный ключ.
3. Запросите TRX через faucet:
   - Shasta: `https://www.trongrid.io/shasta?ref=tronfaucet`
   - Nile: `https://nileex.io/join/getJoinPage`
4. Для USDT TRC-20 воспользуйтесь тестовой версией JustLend/JustSwap или запросите токены в Telegram-чатах Tron Developers. Баланс проверяйте через `https://nile.tronscan.org/#/address/<адрес>`.

### 4.4 TON Testnet

TON-транзакции выполняет `TonTransactionService`, который требует публичный/приватный ключи кошелька и API-ключ Toncenter.

Обязательные переменные:

- `TON_NETWORK=testnet`
- `TON_API_KEY` — ключ доступа Toncenter (можно получить бесплатно для тестнета).
- `TON_WALLET_PUBLIC_KEY`
- `TON_WALLET_PRIVATE_KEY`

Опционально:

- `TON_API_ENDPOINT` — если нужен другой RPC.

Для jetton-токенов укажите `tokenContract` и `decimal` в конфигурации валют, либо создайте кастомный объект при вызове сервиса.

**Как получить адрес и токены:**

1. Установите `toncli` (`pip install toncli`) или используйте [https://wallet.ton.org/](https://wallet.ton.org/) с переключением на Testnet. Создайте новый кошелёк и выгрузите seed phrase; из неё toncli позволяет получить публичный/приватный ключи:
   ```bash
   toncli -n testnet start
   toncli -n testnet gen-keys wallet
   ```
2. Запросите TON через официальный faucet: `https://ton.org/testnet/faucet`. Укажите адрес вида `EQ...` и дождитесь появления средств.
3. Для jettonов используйте проекты вроде `https://testnet.ston.fi/` (swap TON → jetton) или попросите тестовые токены у владельцев проекта. Не забудьте указать адрес контракта jetton в конфигурации.
4. Убедитесь, что на кошельке есть минимум 0.3 TON для комиссий и 0.05 TON для перевода jettonов.

## 5. Проверка готовности

1. Выполните авторизацию: `npx playwright test src/tests/auth --headed` (по желанию) и убедитесь, что 2FA код успешно читается из Telegram.
2. Запустите кошелёк-тест: `npx playwright test src/tests/wallet/wallet.test.ts`. Тест создаёт кошельки, проводит депозиты и удаляет их, используя вышеописанные сервисы.
3. В случае ошибок проверьте баланс аккаунтов и корректность RPC-узлов; большинство исключений содержат подсказки в логах (`console.info/error`).

После выполнения пунктов выше окружение готово к прогонам методов создания токенов и связанного с ними депозита на тестовых сетях.
